import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc
} from 'firebase/firestore';
import { 
  Save, 
  Image as ImageIcon, 
  Upload, 
  Trash2, 
  Loader2, 
  CheckCircle2, 
  Link as LinkIcon,
  ChevronDown,
  ChevronRight,
  XCircle,
  Minimize2,
  Maximize2,
  Edit3,
  Menu
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Default Content (Static Text + Image placeholders) ---
const DEFAULT_CONTENT = {
  hero: {
    title: "à¦à¦• à¦¡à§‹à¦œà§‡à¦‡ à¦–à§‡à¦² à¦–à¦¤à¦®!",
    subtitle: "à¦†à¦œ à¦¥à§‡à¦•à§‡à¦‡ à¦¶à§à¦°à§ à¦¹à§‹à¦•....",
    buttonText: "à¦•à§à¦°à¦¿à¦®à¦¿à¦° à¦¬à¦¿à¦°à§à¦¦à§à¦§à§‡ à¦¯à§à¦¦à§à¦§",
    backgroundImage: "https://github.com/Sayeed127/Almex/blob/main/Image/Untitled%20design%20(3).png?raw=true", 
    styles: {
      backgroundColor: "#fdf3e4",
      titleColor: "#2d9cdb",
      subtitleColor: "#2d9cdb",
      buttonColor: "#2D9CDB",
      align: "left", 
      titleSize: "2.75", 
      buttonSize: "2.125"
    }
  },
  myths: {
    title: "à¦¸à¦¾à¦¬à¦§à¦¾à¦¨!ðŸš¨",
    subtitle: "à¦•à§ƒà¦®à¦¿ à¦¸à¦‚à¦•à§à¦°à¦¾à¦¨à§à¦¤ à¦à¦‡ à¦®à¦¿à¦¥à¦—à§à¦²à§‹ à¦†à¦®à¦¾à¦¦à§‡à¦°à¦•à§‡ à¦¬à¦¿à¦­à§à¦°à¦¾à¦¨à§à¦¤ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡", 
    items: [
      { myth: "à¦®à¦¿à¦·à§à¦Ÿà¦¿ à¦–à§‡à¦²à§‡à¦‡ à¦•à§ƒà¦®à¦¿ à¦¹à§Ÿ?", fact: "à¦­à§à¦²! à¦®à¦¿à¦·à§à¦Ÿà¦¿ à¦•à§ƒà¦®à¦¿à¦° à¦œà¦¨à§à¦¯ à¦¦à¦¾à§Ÿà§€ à¦¨à§Ÿ!" },
      { myth: "à¦•à§ƒà¦®à¦¿ à¦¹à¦œà¦®à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦•à¦°à§‡?", fact: "à¦“à¦°à¦¾ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯à¦•à¦¾à¦°à§€ à¦¬à¦¨à§à¦§à§ à¦¨à§Ÿ, à¦¬à¦°à¦‚ à¦“à¦°à¦¾ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦–à¦¾à¦¬à¦¾à¦°à§‡à¦° à¦ªà§à¦·à§à¦Ÿà¦¿ à¦šà§à¦°à¦¿ à¦•à¦°à§‡ à¦¨à§‡à§Ÿ!" },
      { myth: "à¦”à¦·à¦§ à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦°à¦¾à¦¤à§‡ à¦–à§‡à¦¤à§‡ à¦¹à§Ÿ?", fact: "à¦¡à¦¾à¦•à§à¦¤à¦¾à¦°à§‡à¦° à¦ªà¦°à¦¾à¦®à¦°à§à¦¶ à¦…à¦¨à§à¦¯à¦¾à§Ÿà§€ à¦”à¦·à¦§ à¦¯à§‡à¦•à§‹à¦¨à§‹ à¦¸à¦®à§Ÿà¦‡ à¦•à§ƒà¦®à¦¿à¦•à§‡ à¦˜à¦¾à§Ÿà§‡à¦² à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡!" },
      { myth: "à¦¬à§œà¦¦à§‡à¦° à¦•à§ƒà¦®à¦¿ à¦¹à§Ÿ à¦¨à¦¾?", fact: "à¦•à§ƒà¦®à¦¿ à¦›à§‹à¦Ÿ-à¦¬à§œ à¦•à¦¾à¦‰à¦•à§‡à¦‡ à¦›à¦¾à§œ à¦¦à§‡à§Ÿ à¦¨à¦¾! à¦¸à¦¬à¦¾à¦‡à¦•à§‡à¦‡ à¦¸à¦¤à¦°à§à¦• à¦¥à¦¾à¦•à¦¤à§‡ à¦¹à¦¬à§‡!" }
    ],
    image: "https://github.com/Sayeed127/Almex/blob/main/Image/Warn.png?raw=true",
    styles: {
      backgroundColor: "#f9d5af",
      titleColor: "#EB5757",
      cardBackground: "#FFF9F0",
      cardBorder: "#F2C94C",
      textColor: "#374151"
    }
  },
  reality: {
    text: "à¦à¦‡ à¦¸à¦¬ à¦§à¦¾à¦°à¦£à¦¾à¦‡ à¦­à¦¿à¦¤à§à¦¤à¦¿à¦¹à§€à¦¨! à¦•à§ƒà¦®à¦¿à¦° à¦šà¦¾à¦²à¦¾à¦•à¦¿à¦¤à§‡ à¦¬à¦¿à¦­à§à¦°à¦¾à¦¨à§à¦¤ à¦¹à¦¬à§‡à¦¨ à¦¨à¦¾!",
    styles: {
      backgroundColor: "#FFF9F0",
      textColor: "#EB5757",
      align: "center"
    }
  },
  causes: {
    title: "à¦•à§ƒà¦®à¦¿ à¦†à¦•à§à¦°à¦®à¦£à§‡à¦° à¦¸à¦®à§à¦­à¦¾à¦¬à§à¦¯ à¦ªà¦¥à¦—à§à¦²à§‹ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦œà¦¾à¦¨à¦¤à§‡ à¦¹à¦¬à§‡",
    footnote: "à¦•à§ƒà¦®à¦¿ à¦¸à¦‚à¦•à§à¦°à¦¾à¦®à¦•, à¦¤à¦¾à¦‡ à¦à¦•à¦œà¦¨à§‡à¦° à¦¹à¦²à§‡ à¦ªà¦°à¦¿à¦¬à¦¾à¦°à§‡à¦° à¦¸à¦¬à¦¾à¦° à¦¹à¦“à§Ÿà¦¾à¦° à¦¸à¦®à§à¦­à¦¾à¦¬à¦¨à¦¾ à¦¥à¦¾à¦•à§‡à¥¤", 
    items: [
      "à§§. à¦…à¦ªà¦°à¦¿à¦šà§à¦›à¦¨à§à¦¨ à¦ªà¦°à¦¿à¦¬à§‡à¦¶ â€“ à¦à¦Ÿà¦¿ à¦•à§ƒà¦®à¦¿à¦¦à§‡à¦° à¦²à§à¦•à¦¾à¦¨à§‹à¦° à¦¸à§‡à¦°à¦¾ à¦œà¦¾à§Ÿà¦—à¦¾!",
      "à§¨. à¦†à¦§à¦¾-à¦¸à¦¿à¦¦à§à¦§ à¦–à¦¾à¦¬à¦¾à¦° â€“ à¦¬à¦¿à¦¶à§‡à¦· à¦•à¦°à§‡ à¦®à¦¾à¦› à¦¬à¦¾ à¦®à¦¾à¦‚à¦¸, à¦•à§ƒà¦®à¦¿à¦° à¦œà¦¨à§à¦¯ à¦‰à¦ªà¦¯à§‹à¦—à§€!",
      "à§©. à¦¦à§‚à¦·à¦¿à¦¤ à¦®à¦¾à¦Ÿà¦¿ à¦“ à¦ªà¦¾à¦¨à¦¿ â€“ à¦²à§à¦•à¦¾à¦¨à§‹ à¦«à¦¾à¦à¦¦; à¦¸à§à¦ªà¦°à§à¦¶ à¦•à¦°à¦²à§‡à¦‡ à¦¬à¦¿à¦ªà¦¦!",
      "à§ª. à¦¨à§‹à¦‚à¦°à¦¾ à¦¹à¦¾à¦¤! à¦–à¦¾à¦“à§Ÿà¦¾à¦° à¦†à¦—à§‡ à¦¬à¦¾ à¦Ÿà§Ÿà¦²à§‡à¦Ÿà§‡à¦° à¦ªà¦° à¦¹à¦¾à¦¤ à¦¨à¦¾ à¦§à§à¦²à§‡, à¦•à§ƒà¦®à¦¿ à¦¸à¦¹à¦œà§‡à¦‡ à¦ªà§‡à¦Ÿà§‡ à¦†à¦•à§à¦°à¦®à¦£ à¦•à¦°à¦¬à§‡!"
    ],
    image: "https://github.com/Sayeed127/Almex/blob/main/Image/Map.png?raw=true",
    styles: {
      backgroundColor: "#d7ffea",
      titleColor: "#2D9CDB",
      cardBackground: "#FFFFFF",
      textColor: "#374151",
      footnoteBackground: "#FFF9F0", 
      footnoteTextColor: "#EB5757"    
    }
  },
  symptoms: {
    title: "à¦†à¦ªà¦¨à¦¾à¦° à¦¶à¦°à§€à¦° à¦•à¦¿ à¦à¦‡ à¦¬à¦¿à¦ªà¦¦ à¦¸à¦‚à¦•à§‡à¦¤à¦—à§à¦²à§‹ à¦¦à¦¿à¦šà§à¦›à§‡?",
    items: [
      "à§§. à¦ªà§‡à¦Ÿ à¦¬à§à¦¯à¦¥à¦¾ à¦“ à¦«à§‹à¦²à¦¾ à¦­à¦¾à¦¬",
      "à§¨. à¦®à¦²à¦¦à§à¦¬à¦¾à¦° à¦šà§à¦²à¦•à¦¾à¦¨à¦¿",
      "à§©. à¦¬à¦®à¦¿ à¦¬à¦®à¦¿ à¦­à¦¾à¦¬ à¦¬à¦¾ à¦¬à¦®à¦¿ à¦¹à¦“à¦¯à¦¼à¦¾",
      "à§ª. à¦•à§à¦·à§à¦§à¦¾à¦®à¦¨à§à¦¦à¦¾",
      "à§«. à¦¡à¦¾à¦¯à¦¼à¦°à¦¿à¦¯à¦¼à¦¾",
      "à§¬. à¦°à¦•à§à¦¤à¦¶à§‚à¦¨à§à¦¯à¦¤à¦¾",
      "à§­. à¦“à¦œà¦¨ à¦¹à§à¦°à¦¾à¦¸",
      "à§®. à¦¦à§à¦°à§à¦¬à¦²à¦¤à¦¾ à¦¬à¦¾ à¦•à§à¦²à¦¾à¦¨à§à¦¤à¦¿ à¦…à¦¨à§à¦­à¦¬ à¦•à¦°à¦¾",
      "à§¯. à¦®à¦¾à¦¥à¦¾ à¦¬à§à¦¯à¦¾à¦¥à¦¾ à¦“ à¦®à§‡à¦œà¦¾à¦œ à¦–à¦¿à¦Ÿà¦–à¦¿à¦Ÿà§‡"
    ],
    styles: {
      backgroundColor: "#f9d5af",
      titleColor: "#333333",
      cardBackground: "#FFFFFF",
      cardTextColor: "#4B5563",
      align: "center"
    }
  },
  footer: {
    title: "à¦²à¦•à§à¦·à¦£ à¦®à¦¿à¦²à§‡ à¦—à§‡à¦²à§‡à¦‡ à¦šà§‚à§œà¦¾à¦¨à§à¦¤ à¦¸à¦¤à¦°à§à¦•à¦¬à¦¾à¦°à§à¦¤à¦¾ðŸš¨",
    description: "à¦†à¦° à¦¦à§‡à¦°à¦¿ à¦¨à§Ÿ! à¦à¦–à¦¨à¦¿ à¦šà¦¿à¦•à¦¿à§Žà¦¸à¦•à§‡à¦° à¦¶à¦°à¦£à¦¾à¦ªà¦¨à§à¦¨ à¦¹à§‹à¦¨!",
    footnote: "à¦•à§ƒà¦®à¦¿à¦•à§‡ à¦¬à¦‚à¦¶à¦¬à¦¿à¦¸à§à¦¤à¦¾à¦°à§‡à¦° à¦†à¦° à¦à¦• à¦®à§à¦¹à§‚à¦°à§à¦¤à¦“ à¦¸à§à¦¯à§‹à¦— à¦¦à§‡à¦¬à§‡à¦¨ à¦¨à¦¾!",
    image: "https://github.com/Sayeed127/Almex/blob/main/Image/Alert.png?raw=true",
    styles: {
      backgroundColor: "#2D9CDB",
      titleColor: "#FFFFFF",
      textColor: "#FFFFFF",
      align: "center",
      footnoteBackground: "#FFF9F0", 
      footnoteTextColor: "#EB5757",
      imageMaxWidth: "600px" 
    }
  },
  extraSection: {
    title: "à¦†à¦•à§à¦°à¦¾à¦¨à§à¦¤ à¦¹à¦¨à¦¨à¦¿?",
    description: "à¦–à§à¦¬ à¦­à¦¾à¦²à§‹ à¦–à¦¬à¦°! à¦•à¦¿à¦¨à§à¦¤à§ à¦¸à¦¾à¦¬à¦§à¦¾à¦¨à¦¤à¦¾ à¦à¦–à¦¨à§‹ à¦¶à§‡à¦· à¦¹à§Ÿà¦¨à¦¿! à¦¶à¦¤à§à¦°à§à¦•à§‡ à¦¸à§€à¦®à¦¾à¦¨à¦¾à¦° à¦¬à¦¾à¦‡à¦°à§‡ à¦°à¦¾à¦–à¦¤à§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° 'à¦¸à§à¦°à¦•à§à¦·à¦¾ à¦¨à¦¿à§Ÿà¦®à¦—à§à¦²à§‹' (à¦¹à¦¾à¦¤ à¦§à§‹à§Ÿà¦¾, à¦¸à¦ à¦¿à¦• à¦–à¦¾à¦¬à¦¾à¦°, à¦ªà¦°à¦¿à¦šà§à¦›à¦¨à§à¦¨à¦¤à¦¾) à¦•à§œà¦¾à¦•à§œà¦¿à¦­à¦¾à¦¬à§‡ à¦®à§‡à¦¨à§‡ à¦šà¦²à¦¤à§‡ à¦¹à¦¬à§‡!",
    items: [
      "à¦ªà§à¦°à¦¤à¦¿ à¦›à§Ÿ à¦®à¦¾à¦¸ à¦…à¦¨à§à¦¤à¦° à¦…à¦¨à§à¦¤à¦° à¦¡à¦¾à¦•à§à¦¤à¦¾à¦°à§‡à¦° à¦ªà¦°à¦¾à¦®à¦°à§à¦¶ à¦…à¦¨à§à¦¯à¦¾à§Ÿà§€ à¦“à¦·à§à¦§ à¦¸à§‡à¦¬à¦¨ à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡",
      "à¦ªà¦°à¦¿à¦¬à¦¾à¦°à§‡à¦° à¦¸à¦•à¦² à¦¸à¦¦à¦¸à§à¦¯à¦•à§‡ à¦à¦•à¦¸à¦¾à¦¥à§‡ à¦“à¦·à§à¦§ à¦¸à§‡à¦¬à¦¨ à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡"
    ],
    footnote: "Almex",
    image: "https://github.com/Sayeed127/Almex/blob/main/Image/Final.png?raw=true", 
    styles: {
      backgroundColor: "#ffffff",
      titleColor: "#2D9CDB",
      textColor: "#4B5563",
      align: "left",
      footnoteBackground: "#FFF9F0",
      footnoteTextColor: "#EB5757"
    }
  }
};

// --- Main CMS Component ---
export default function ImageCmsApp() {
  const [user, setUser] = useState(null);
  const [content, setContent] = useState(DEFAULT_CONTENT);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [saveStatus, setSaveStatus] = useState(null);
  const [activeSection, setActiveSection] = useState('hero');
  const [isEditorOpen, setIsEditorOpen] = useState(true); 

  // 1. Initialize Auth
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Auth failed", e);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Fetch Data
  useEffect(() => {
    if (!user) return;
    const fetchData = async () => {
      setLoading(true);
      try {
        // Bumped to main-v8 to ensure new list content loads
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'landing-pages', 'main-v8');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          // Merge to ensure new fields (items) exist
          const mergedContent = {
             ...DEFAULT_CONTENT,
             ...data,
             extraSection: {
                ...DEFAULT_CONTENT.extraSection,
                ...data.extraSection,
                items: data.extraSection?.items || DEFAULT_CONTENT.extraSection.items
             }
          };
          setContent(mergedContent);
        } else {
          await setDoc(docRef, DEFAULT_CONTENT);
          setContent(DEFAULT_CONTENT);
        }
      } catch (err) {
        console.error("Error fetching content:", err);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, [user]);

  // 3. Save Data
  const handleSave = async () => {
    if (!user) return;
    setSaving(true);
    setSaveStatus(null);
    try {
      const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'landing-pages', 'main-v8');
      await setDoc(docRef, content);
      setSaveStatus('success');
      setTimeout(() => setSaveStatus(null), 3000);
    } catch (err) {
      console.error("Error saving content:", err);
      setSaveStatus('error');
      alert("Failed to save. Ensure images are not too large (>1MB combined).");
    } finally {
      setSaving(false);
    }
  };

  const updateField = (section, field, value) => {
    setContent(prev => ({
      ...prev,
      [section]: {
        ...prev[section],
        [field]: value
      }
    }));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <Loader2 className="w-8 h-8 animate-spin text-blue-500" />
      </div>
    );
  }

  return (
    <div className="relative w-full h-screen overflow-hidden bg-gray-100 font-sans">
      
      {/* --- Layer 1: Full Screen Live Preview --- */}
      <div className="absolute inset-0 w-full h-full overflow-y-auto custom-scrollbar bg-white z-0">
         <PreviewPage content={content} />
      </div>

      {/* --- Layer 2: Floating Editor Controls --- */}
      
      {/* Minimized FAB (Visible when editor is closed) */}
      {!isEditorOpen && (
        <button 
          onClick={() => setIsEditorOpen(true)}
          className="fixed bottom-6 right-6 md:left-6 md:right-auto z-50 flex items-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-full shadow-xl hover:bg-blue-700 hover:scale-105 transition-all animate-in fade-in zoom-in duration-300"
        >
          <Edit3 className="w-5 h-5" />
          <span className="font-semibold hidden md:inline">Edit Images</span>
        </button>
      )}

      {/* Floating Panel Container */}
      {isEditorOpen && (
        <div className={`
          fixed z-50 bg-white/95 backdrop-blur-md shadow-2xl border border-white/20 
          transition-all duration-300 ease-in-out flex flex-col
          
          /* Mobile: Bottom Sheet */
          inset-x-0 bottom-0 top-auto rounded-t-2xl max-h-[70vh]
          
          /* Desktop: Floating Sidebar */
          md:top-4 md:left-4 md:bottom-4 md:right-auto md:w-[380px] md:rounded-2xl md:max-h-[calc(100vh-2rem)]
        `}>
          
          {/* Panel Header */}
          <div className="flex items-center justify-between p-4 border-b bg-white/50 backdrop-blur-sm shrink-0">
             <div className="flex items-center gap-2">
                <div className="bg-blue-100 p-1.5 rounded-lg">
                  <ImageIcon className="w-4 h-4 text-blue-600" />
                </div>
                <h1 className="font-bold text-gray-800 text-sm">Image Manager</h1>
             </div>
             <div className="flex items-center gap-2">
                <button 
                  onClick={() => setIsEditorOpen(false)}
                  className="p-1.5 text-gray-500 hover:bg-gray-100 rounded-full transition-colors"
                  title="Minimize"
                >
                  <Minimize2 className="w-4 h-4" />
                </button>
             </div>
          </div>

          {/* Panel Content (Scrollable) */}
          <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
            
            <ImageSection 
              title="Hero Background" 
              id="hero" 
              activeId={activeSection} 
              setActive={setActiveSection}
            >
              <ImagePicker 
                label="Background Image" 
                value={content.hero.backgroundImage} 
                onChange={(val) => updateField('hero', 'backgroundImage', val)} 
              />
              <p className="text-xs text-gray-400 mt-2">Recommended: Landscape (16:9), High Quality</p>
            </ImageSection>

            <ImageSection 
              title="Myths Section" 
              id="myths" 
              activeId={activeSection} 
              setActive={setActiveSection}
            >
              <ImagePicker 
                label="Side Image" 
                value={content.myths.image} 
                onChange={(val) => updateField('myths', 'image', val)} 
              />
              <p className="text-xs text-gray-400 mt-2">Recommended: Transparent PNG of Character</p>
            </ImageSection>

            <ImageSection 
              title="Causes Section" 
              id="causes" 
              activeId={activeSection} 
              setActive={setActiveSection}
            >
              <ImagePicker 
                label="Side Image" 
                value={content.causes.image} 
                onChange={(val) => updateField('causes', 'image', val)} 
              />
            </ImageSection>

            <ImageSection 
              title="Footer Image" 
              id="footer" 
              activeId={activeSection} 
              setActive={setActiveSection}
            >
              <ImagePicker 
                label="Footer Image" 
                value={content.footer.image} 
                onChange={(val) => updateField('footer', 'image', val)} 
              />
              <p className="text-xs text-gray-400 mt-2">Recommended: High Quality</p>
            </ImageSection>

            <ImageSection 
              title="Extra Section" 
              id="extraSection" 
              activeId={activeSection} 
              setActive={setActiveSection}
            >
              <ImagePicker 
                label="Side Image" 
                value={content.extraSection.image} 
                onChange={(val) => updateField('extraSection', 'image', val)} 
              />
            </ImageSection>

          </div>

          {/* Footer Save Button */}
          <div className="p-4 border-t bg-gray-50/80 backdrop-blur shrink-0 pb-8 md:pb-4">
            <button
              onClick={handleSave}
              disabled={saving}
              className={`w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold transition-all ${
                saveStatus === 'success' ? 'bg-green-500 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {saving ? <Loader2 className="w-5 h-5 animate-spin" /> : saveStatus === 'success' ? <CheckCircle2 className="w-5 h-5" /> : <Save className="w-5 h-5" />}
              {saving ? 'Saving...' : saveStatus === 'success' ? 'Images Saved!' : 'Save Images'}
            </button>
          </div>
        </div>
      )}

    </div>
  );
}

// --- CMS UI Components ---

const ImageSection = ({ title, id, activeId, setActive, children }) => {
  const isOpen = activeId === id;
  return (
    <div className={`border rounded-xl bg-white transition-all ${isOpen ? 'ring-2 ring-blue-500/20 shadow-md' : 'shadow-sm'}`}>
      <button 
        onClick={() => setActive(isOpen ? null : id)}
        className="w-full flex items-center justify-between p-3 font-medium text-gray-700 hover:bg-gray-50 rounded-t-xl"
      >
        <span className="flex items-center gap-2"><ImageIcon className="w-4 h-4 text-blue-500" /> {title}</span>
        {isOpen ? <ChevronDown className="w-4 h-4 text-gray-400" /> : <ChevronRight className="w-4 h-4 text-gray-400" />}
      </button>
      {isOpen && <div className="p-3 pt-0 border-t">{children}</div>}
    </div>
  );
};

const ImagePicker = ({ label, value, onChange }) => {
  const fileInputRef = useRef(null);
  const [isCompressing, setIsCompressing] = useState(false);

  const handleFileChange = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert("File is too large! Please upload an image under 5MB.");
      return;
    }

    setIsCompressing(true);
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        const MAX_WIDTH = 800; 
        
        if (width > MAX_WIDTH) {
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Transparent Handling
        const fileType = file.type;
        const isTransparent = fileType === 'image/png' || fileType === 'image/webp';
        const outputFormat = isTransparent ? 'image/webp' : 'image/jpeg';
        
        const dataUrl = canvas.toDataURL(outputFormat, 0.7);
        onChange(dataUrl);
        setIsCompressing(false);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  };

  return (
    <div className="mt-3">
      {!value ? (
        <div 
          onClick={() => fileInputRef.current?.click()}
          className="border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-white hover:border-blue-400 transition-all cursor-pointer h-32 flex flex-col items-center justify-center text-gray-400 gap-2 group"
        >
          {isCompressing ? <Loader2 className="w-6 h-6 animate-spin text-blue-500" /> : <Upload className="w-6 h-6 group-hover:scale-110 transition-transform" />}
          <span className="text-xs font-medium">{isCompressing ? "Processing..." : "Click to Upload"}</span>
        </div>
      ) : (
        <div className="relative group rounded-xl overflow-hidden border border-gray-200 shadow-sm bg-gray-100">
          <img src={value} alt="Preview" className="w-full h-40 object-cover" />
          <button 
            onClick={() => onChange(null)}
            className="absolute top-2 right-2 bg-white/90 p-1.5 rounded-full text-red-500 hover:text-red-700 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
          >
            <Trash2 className="w-4 h-4" />
          </button>
          <div className="absolute bottom-0 inset-x-0 bg-black/50 text-white text-[10px] py-1 text-center backdrop-blur-sm">
            Image Set
          </div>
        </div>
      )}
      <input 
        type="file" 
        ref={fileInputRef} 
        onChange={handleFileChange} 
        accept="image/*" 
        className="hidden" 
      />
      <div className="flex items-center gap-2 mt-2">
        <LinkIcon className="w-3 h-3 text-gray-400" />
        <input 
          type="text" 
          placeholder="Or paste URL..." 
          value={value && value.startsWith('http') ? value : ''}
          onChange={(e) => onChange(e.target.value)}
          className="flex-1 text-xs border-b border-gray-200 py-1 outline-none focus:border-blue-500 bg-transparent text-gray-600"
        />
      </div>
    </div>
  );
};

// --- Landing Page Preview ---

const PreviewPage = ({ content }) => {
  return (
    <div className="font-sans text-gray-800 antialiased selection:bg-blue-100 selection:text-blue-900 min-h-screen bg-white">
      <style>
        {`@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');`}
      </style>
      <div style={{ fontFamily: '"Hind Siliguri", sans-serif' }}>
        
        {/* Header */}
        <header className="py-5 absolute w-full top-0 z-20">
          <div className="max-w-6xl mx-auto px-5">
            <div className="text-2xl font-extrabold text-[#333]">WormInfo</div>
          </div>
        </header>

        {/* Hero Section */}
        <section 
            style={{ 
                backgroundColor: content.hero.styles.backgroundColor,
                backgroundImage: content.hero.backgroundImage ? `url("${content.hero.backgroundImage}")` : 'none',
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                backgroundRepeat: 'no-repeat'
            }} 
            className="pt-28 pb-16 md:pt-36 md:pb-20 relative transition-all duration-300 min-h-[500px] md:min-h-[600px] flex items-center"
        >
          <div className="max-w-6xl mx-auto px-5 relative z-10 w-full">
            <div style={{ textAlign: content.hero.styles.align }}>
                <h1 
                    style={{ 
                        color: content.hero.styles.titleColor,
                        // Responsive Font Sizing using Clamp
                        fontSize: `clamp(2rem, 5vw + 1rem, ${content.hero.styles.titleSize}rem)`
                    }}
                    className="font-bold mb-3 leading-tight"
                >
                {content.hero.title}
                </h1>
                <h2 
                    style={{ color: content.hero.styles.subtitleColor }}
                    className="text-2xl md:text-3xl lg:text-4xl font-normal mb-8"
                >
                {content.hero.subtitle}
                </h2>
                <button 
                    style={{ 
                        backgroundColor: content.hero.styles.buttonColor,
                        fontSize: `clamp(1rem, 2vw + 0.5rem, ${content.hero.styles.buttonSize}rem)`
                    }}
                    className="text-white font-semibold px-6 py-3 md:px-8 md:py-4 rounded-full shadow-lg hover:-translate-y-1 transition-all"
                >
                {content.hero.buttonText}
                </button>
            </div>
          </div>
        </section>

        {/* Myths Section */}
        <section 
            style={{ backgroundColor: content.myths.styles.backgroundColor }}
            className="py-12 md:py-20 transition-colors duration-300"
        >
          <div className="max-w-6xl mx-auto px-5 grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 items-center">
            <div>
              <div className="mb-8">
                <h3 
                    style={{ color: content.myths.styles.titleColor }}
                    className="text-2xl md:text-3xl font-bold mb-2"
                >
                    {content.myths.title}
                </h3>
                {content.myths.subtitle && (
                    <p className="text-lg md:text-xl text-[#EB5757] font-medium">
                        {content.myths.subtitle}
                    </p>
                )}
              </div>
              <div className="space-y-4 md:space-y-6">
                {content.myths.items.map((item, idx) => (
                  <div 
                    key={idx} 
                    style={{ 
                        backgroundColor: content.myths.styles.cardBackground,
                        borderColor: content.myths.styles.cardBorder,
                    }}
                    className="border-l-4 rounded-r-lg shadow-sm overflow-hidden"
                  >
                    <div className="p-4 bg-white/50 border-b border-gray-100 flex items-start gap-3">
                        <XCircle className="w-5 h-5 md:w-6 md:h-6 text-red-500 shrink-0 mt-0.5" />
                        <div className="text-base md:text-lg font-semibold text-gray-800">
                            {item.myth}
                        </div>
                    </div>
                    {item.fact && (
                        <div className="p-4 bg-[#f0fdf4] flex items-start gap-3">
                            <CheckCircle2 className="w-5 h-5 md:w-6 md:h-6 text-green-600 shrink-0 mt-0.5" />
                            <div className="text-base md:text-lg font-medium text-gray-700">
                                {item.fact}
                            </div>
                        </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
            <div className="order-first md:order-last">
              {content.myths.image ? (
                 <img src={content.myths.image} alt="Myths" className="w-full rounded-3xl" />
              ) : (
                 <div className="h-[250px] md:h-[350px] w-full rounded-3xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-400 font-medium">
                    Myth Image Placeholder
                 </div>
              )}
            </div>
          </div>
        </section>

        {/* Reality Strip */}
        <div style={{ backgroundColor: content.myths.styles.backgroundColor }}>
            <div className="max-w-6xl mx-auto px-5 py-8 md:py-10">
            <div 
                style={{ 
                    backgroundColor: content.reality.styles.backgroundColor,
                    textAlign: content.reality.styles.align
                }}
                className="py-6 px-4 md:py-8 md:px-6 rounded-3xl transition-colors duration-300 shadow-sm"
            >
                <h4 
                    style={{ color: content.reality.styles.textColor }}
                    className="text-lg md:text-2xl font-bold"
                >
                {content.reality.text}
                </h4>
            </div>
            </div>
        </div>

        {/* Causes Section */}
        <section 
            style={{ backgroundColor: content.causes.styles.backgroundColor }}
            className="py-12 md:py-20 transition-colors duration-300"
        >
          <div className="max-w-6xl mx-auto px-5 grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 items-center mb-8 md:mb-12">
             <div className="text-center">
               {content.causes.image ? (
                  <img src={content.causes.image} alt="Causes" className="w-full rounded-3xl" />
               ) : (
                  <div className="h-[250px] md:h-[350px] w-full rounded-3xl bg-white/50 border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 font-medium">
                      Causes Image Placeholder
                  </div>
               )}
            </div>
            <div>
              <h3 
                style={{ color: content.causes.styles.titleColor }}
                className="text-2xl md:text-3xl font-bold mb-6 md:mb-8"
              >
                {content.causes.title}
              </h3>
              <ul className="space-y-3 md:space-y-4">
                {content.causes.items.map((item, idx) => (
                  <li 
                    key={idx} 
                    style={{ 
                        backgroundColor: content.causes.styles.cardBackground,
                        color: content.causes.styles.textColor
                    }}
                    className="p-3 md:p-4 rounded-xl shadow-sm text-base md:text-lg flex items-start gap-3 transition-colors duration-300"
                  >
                    <span 
                        style={{ backgroundColor: content.causes.styles.titleColor }}
                        className="w-2 h-2 rounded-full mt-2.5 shrink-0" 
                    />
                    {item}
                  </li>
                ))}
              </ul>
            </div>
          </div>

          {/* Causes Footnote Strip */}
          {content.causes.footnote && (
            <div className="max-w-6xl mx-auto px-5">
                <div 
                    style={{ 
                        backgroundColor: content.causes.styles.footnoteBackground,
                        textAlign: 'center'
                    }}
                    className="py-6 px-4 md:py-8 md:px-6 rounded-3xl transition-colors duration-300 shadow-sm"
                >
                    <h4 
                        style={{ color: content.causes.styles.footnoteTextColor }}
                        className="text-lg md:text-2xl font-bold"
                    >
                        {content.causes.footnote}
                    </h4>
                </div>
            </div>
          )}
        </section>

        {/* Symptoms Section */}
        <section 
            style={{ 
                backgroundColor: content.symptoms.styles.backgroundColor,
                textAlign: content.symptoms.styles.align
            }}
            className="py-12 md:py-20 transition-colors duration-300"
        >
          <div className="max-w-6xl mx-auto px-5">
            <h2 
                style={{ color: content.symptoms.styles.titleColor }}
                className="text-3xl md:text-4xl font-bold mb-8 md:mb-12"
            >
              {content.symptoms.title}
            </h2>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4 md:gap-6">
              {content.symptoms.items.map((item, idx) => (
                <div 
                    key={idx} 
                    style={{ 
                        backgroundColor: content.symptoms.styles.cardBackground,
                        color: content.symptoms.styles.cardTextColor
                    }}
                    className="p-4 md:p-6 rounded-2xl border border-gray-100 shadow-md hover:shadow-lg transition-all text-center flex items-center justify-center min-h-[100px] md:min-h-[120px]"
                >
                  <p className="font-semibold text-base md:text-lg">{item}</p>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* Footer CTA */}
        <section 
            style={{ 
                backgroundColor: content.footer.styles.backgroundColor,
                textAlign: content.footer.styles.align
            }}
            className="py-12 md:py-20 relative overflow-hidden transition-colors duration-300"
        >
          <div className="max-w-4xl mx-auto px-5 relative z-10">
            <h2 
                style={{ color: content.footer.styles.titleColor }}
                className="text-3xl md:text-4xl font-bold mb-6"
            >
              {content.footer.title}
            </h2>
            <p 
                style={{ color: content.footer.styles.textColor }}
                className="text-lg md:text-xl opacity-90 leading-relaxed whitespace-pre-line"
            >
              {content.footer.description}
            </p>
            <div className="mt-8 md:mt-10 flex justify-center mb-8 md:mb-12">
               {content.footer.image ? (
                  // Updated image rendering to respect max width and maintain flexible ratio
                  <img 
                    src={content.footer.image} 
                    alt="Footer Icon" 
                    style={{ maxWidth: content.footer.styles.imageMaxWidth || '600px' }}
                    className="h-auto rounded-3xl" 
                  />
               ) : (
                  <div className="w-[250px] md:w-[300px] h-[180px] md:h-[200px] rounded-3xl border-2 border-dashed border-white/30 bg-white/10 backdrop-blur flex items-center justify-center text-white/50 font-medium">
                      Footer Image
                  </div>
               )}
            </div>
          </div>

          {/* Footer Footnote Strip */}
          {content.footer.footnote && (
            <div className="max-w-6xl mx-auto px-5 relative z-10">
                <div 
                    style={{ 
                        backgroundColor: content.footer.styles.footnoteBackground,
                        textAlign: 'center'
                    }}
                    className="py-6 px-4 md:py-8 md:px-6 rounded-3xl transition-colors duration-300 shadow-sm"
                >
                    <h4 
                        style={{ color: content.footer.styles.footnoteTextColor }}
                        className="text-lg md:text-2xl font-bold"
                    >
                        {content.footer.footnote}
                    </h4>
                </div>
            </div>
          )}
        </section>

        {/* Extra Section */}
        <section 
            style={{ backgroundColor: content.extraSection.styles.backgroundColor }}
            className="py-12 md:py-20 transition-colors duration-300"
        >
          <div className="max-w-6xl mx-auto px-5 grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 items-center mb-8 md:mb-12">
            {/* Text Side (Left) */}
            <div style={{ textAlign: content.extraSection.styles.align }}>
              <h2 
                  style={{ color: content.extraSection.styles.titleColor }}
                  className="text-3xl md:text-4xl font-bold mb-6"
              >
                {content.extraSection.title}
              </h2>
              <p 
                  style={{ color: content.extraSection.styles.textColor }}
                  className="text-lg md:text-xl leading-relaxed whitespace-pre-line"
              >
                {content.extraSection.description}
              </p>
              
              {/* Bullet Points */}
              {content.extraSection.items && (
                <ul className="mt-6 space-y-3">
                  {content.extraSection.items.map((item, idx) => (
                    <li key={idx} className="flex items-center gap-3">
                       <CheckCircle2 className="w-5 h-5 text-green-500 shrink-0" />
                       <span className="text-base md:text-lg text-gray-700">{item}</span>
                    </li>
                  ))}
                </ul>
              )}
            </div>

            {/* Image Side (Right) */}
            <div className="flex flex-col gap-4">
               {content.extraSection.image ? (
                  <img src={content.extraSection.image} alt="Extra Section" className="w-full rounded-3xl" />
               ) : (
                  <div className="h-[250px] md:h-[350px] w-full rounded-3xl bg-gray-50 border-2 border-dashed border-gray-200 flex items-center justify-center text-gray-400 font-medium">
                      Add Image URL in Code
                  </div>
               )}
            </div>
          </div>

          {/* Extra Section Footnote (Left Aligned Inline-Block) */}
          {content.extraSection.footnote && (
            <div className="max-w-6xl mx-auto px-5">
                <div 
                    style={{ 
                        backgroundColor: content.extraSection.styles.footnoteBackground,
                        textAlign: 'left',
                        display: 'inline-block' 
                    }}
                    className="py-4 px-6 md:px-8 rounded-full transition-colors duration-300 shadow-sm"
                >
                    <h4 
                        style={{ color: content.extraSection.styles.footnoteTextColor }}
                        className="text-lg md:text-2xl font-bold"
                    >
                        {content.extraSection.footnote}
                    </h4>
                </div>
            </div>
          )}
        </section>

      </div>
    </div>
  );
}
